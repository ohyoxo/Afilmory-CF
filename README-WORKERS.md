# Afilmory for Cloudflare Workers

è¿™æ˜¯ Afilmory ç…§ç‰‡ç”»å»Šçš„ Cloudflare Workers ç‰ˆæœ¬ï¼Œå®Œå…¨é€‚é… Workers ç¯å¢ƒï¼Œæ”¯æŒ R2 å­˜å‚¨å’Œè¾¹ç¼˜è®¡ç®—ã€‚

## ğŸŒŸ ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½ä¿ç•™
- âœ… **é«˜æ€§èƒ½ WebGL å›¾ç‰‡æ¸²æŸ“å™¨** - å®Œå…¨ä¿ç•™åŸæœ‰åŠŸèƒ½
- âœ… **å“åº”å¼ç€‘å¸ƒæµå¸ƒå±€** - é€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
- âœ… **ç°ä»£åŒ– UI è®¾è®¡** - Tailwind CSS + Radix UI
- âœ… **å¢é‡åŒæ­¥** - æ™ºèƒ½å˜æ›´æ£€æµ‹ï¼Œåªå¤„ç†æ–°å¢æˆ–ä¿®æ”¹çš„ç…§ç‰‡
- âœ… **å¤šè¯­è¨€æ”¯æŒ** - i18n å›½é™…åŒ–
- âœ… **OpenGraph æ”¯æŒ** - ç¤¾äº¤åª’ä½“åˆ†äº«ä¼˜åŒ–

### Workers ç¯å¢ƒä¼˜åŒ–
- ğŸš€ **è¾¹ç¼˜è®¡ç®—** - å…¨çƒ CDN åŠ é€Ÿï¼Œä½å»¶è¿Ÿè®¿é—®
- ğŸ’¾ **R2 å­˜å‚¨é›†æˆ** - åŸç”Ÿæ”¯æŒ Cloudflare R2 å¯¹è±¡å­˜å‚¨
- ğŸ”„ **KV ç¼“å­˜** - å…ƒæ•°æ®å’Œæ¸…å•æ–‡ä»¶é«˜é€Ÿç¼“å­˜
- âš¡ **æ— æœåŠ¡å™¨æ¶æ„** - é›¶è¿ç»´ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹
- ğŸŒ **å…¨çƒéƒ¨ç½²** - ä¸€é”®éƒ¨ç½²åˆ°å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹

### å›¾ç‰‡å¤„ç†
- ğŸ–¼ï¸ **æ™ºèƒ½ç¼©ç•¥å›¾** - åŠ¨æ€ç”Ÿæˆå¤šå°ºå¯¸ç¼©ç•¥å›¾
- ğŸ“· **EXIF ä¿¡æ¯æå–** - å®Œæ•´çš„æ‹æ‘„å‚æ•°æ˜¾ç¤º
- ğŸŒˆ **Blurhash å ä½ç¬¦** - ä¼˜é›…çš„å›¾ç‰‡åŠ è½½ä½“éªŒ
- ğŸ“± **Live Photo æ”¯æŒ** - iPhone Live Photos æ£€æµ‹å’Œæ˜¾ç¤º
- â˜€ï¸ **HDR å›¾ç‰‡æ”¯æŒ** - é«˜åŠ¨æ€èŒƒå›´å›¾ç‰‡æ˜¾ç¤º

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### åç«¯ (Cloudflare Workers)
- **Cloudflare Workers** - è¾¹ç¼˜è®¡ç®—è¿è¡Œæ—¶
- **R2 Object Storage** - å›¾ç‰‡å’Œé™æ€èµ„æºå­˜å‚¨
- **KV Storage** - å…ƒæ•°æ®å’Œç¼“å­˜å­˜å‚¨
- **TypeScript** - ç±»å‹å®‰å…¨çš„å¼€å‘ä½“éªŒ

### å‰ç«¯ (ä¿æŒåŸæœ‰æŠ€æœ¯æ ˆ)
- **React 19** - æœ€æ–° React ç‰ˆæœ¬
- **TypeScript** - å®Œæ•´ç±»å‹å®‰å…¨
- **Vite** - ç°ä»£æ„å»ºå·¥å…·
- **Tailwind CSS** - åŸå­åŒ– CSS æ¡†æ¶
- **Radix UI** - æ— éšœç¢ç»„ä»¶åº“

### å­˜å‚¨æ¶æ„
- **ä¸»å­˜å‚¨**: Cloudflare R2 (ç…§ç‰‡å’Œé™æ€èµ„æº)
- **ç¼“å­˜å­˜å‚¨**: Cloudflare R2 (ç¼©ç•¥å›¾å’Œå¤„ç†åçš„å›¾ç‰‡)
- **å…ƒæ•°æ®å­˜å‚¨**: Cloudflare KV (ç…§ç‰‡æ¸…å•å’Œé…ç½®)
- **å¤–éƒ¨åŒæ­¥**: æ”¯æŒä» S3ã€GitHub ç­‰å¤–éƒ¨æºåŒæ­¥

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£… Wrangler CLI
npm install -g wrangler

# ç™»å½• Cloudflare
wrangler auth login

# å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/afilmory-workers.git
cd afilmory-workers
```

### 2. ç¯å¢ƒè®¾ç½®

```bash
# å®‰è£…ä¾èµ–
npm install

# è®¾ç½® Cloudflare èµ„æº
npm run setup

# è¿™å°†åˆ›å»ºï¼š
# - R2 å­˜å‚¨æ¡¶ (afilmory-photos, afilmory-cache)
# - KV å‘½åç©ºé—´ (METADATA1_KV)
# - æ›´æ–° wrangler.toml é…ç½®
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶å¹¶ç¼–è¾‘ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# å¤–éƒ¨ S3 å­˜å‚¨ (å¯é€‰)
S3_REGION=us-east-1
S3_ACCESS_KEY_ID=your-access-key-id
S3_SECRET_ACCESS_KEY=your-secret-access-key
S3_BUCKET_NAME=your-source-bucket
S3_PREFIX=photos/

# GitHub é›†æˆ (å¯é€‰)
GITHUB_TOKEN=your-github-token
GITHUB_REPO=username/repo-name

# ç«™ç‚¹é…ç½®
SITE_NAME=My Photo Gallery
SITE_TITLE=My Photo Gallery
SITE_URL=https://your-domain.com
```

### 4. ä¸Šä¼ ç…§ç‰‡

å°†ç…§ç‰‡ä¸Šä¼ åˆ° R2 å­˜å‚¨æ¡¶ï¼š

```bash
# ä½¿ç”¨ wrangler ä¸Šä¼ 
wrangler r2 object put afilmory-photos/2024/photo1.jpg --file=./photos/photo1.jpg

# æˆ–æ‰¹é‡ä¸Šä¼ 
find ./photos -name "*.jpg" -exec wrangler r2 object put afilmory-photos/{} --file={} \;
```

### 5. æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»ºå‰ç«¯åº”ç”¨
npm run build

# éƒ¨ç½²åˆ° Cloudflare Workers
npm run deploy
```

## ğŸ“‹ å¯ç”¨å‘½ä»¤

### å¼€å‘å‘½ä»¤

```bash
# æœ¬åœ°å¼€å‘
npm run dev

# ç±»å‹æ£€æŸ¥
npm run type-check

# ä»£ç æ ¼å¼åŒ–
npm run format

# ä»£ç æ£€æŸ¥
npm run lint
```

### æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»ºå‰ç«¯åº”ç”¨
npm run build:frontend

# ä¸Šä¼ é™æ€èµ„æºåˆ° R2
npm run upload-static

# å®Œæ•´æ„å»º (å‰ç«¯ + é™æ€èµ„æºä¸Šä¼ )
npm run build

# éƒ¨ç½² Worker
npm run deploy

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npm run deploy:production
```

### ç®¡ç†å‘½ä»¤

```bash
# åŒæ­¥ç…§ç‰‡ (è§¦å‘ Worker ä¸­çš„åŒæ­¥)
curl -X POST https://your-worker.your-subdomain.workers.dev/api/sync

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
curl https://your-worker.your-subdomain.workers.dev/api/stats

# è·å–ç…§ç‰‡æ¸…å•
curl https://your-worker.your-subdomain.workers.dev/api/manifest
```

## âš™ï¸ é…ç½®é€‰é¡¹

### wrangler.toml é…ç½®

```toml
name = "afilmory-workers"
main = "src/index.ts"
compatibility_date = "2024-12-01"

# R2 å­˜å‚¨ç»‘å®š
[[r2_buckets]]
binding = "PHOTOS_BUCKET"
bucket_name = "afilmory-photos"

[[r2_buckets]]
binding = "CACHE_BUCKET"
bucket_name = "afilmory-cache"

# KV å­˜å‚¨ç»‘å®š
[[kv_namespaces]]
binding = "METADATA1_KV"
id = "your-kv-namespace-id"
```

### ç¯å¢ƒå˜é‡

| å˜é‡å | æè¿° | å¿…éœ€ |
|--------|------|------|
| `S3_BUCKET_NAME` | å¤–éƒ¨ S3 å­˜å‚¨æ¡¶åç§° | å¦ |
| `S3_ACCESS_KEY_ID` | S3 è®¿é—®å¯†é’¥ ID | å¦ |
| `S3_SECRET_ACCESS_KEY` | S3 è®¿é—®å¯†é’¥ | å¦ |
| `GITHUB_TOKEN` | GitHub è®¿é—®ä»¤ç‰Œ | å¦ |
| `GITHUB_REPO` | GitHub ä»“åº“ | å¦ |

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰åŸŸå

1. åœ¨ Cloudflare Dashboard ä¸­æ·»åŠ è‡ªå®šä¹‰åŸŸå
2. æ›´æ–° `wrangler.toml`:

```toml
[env.production]
routes = [
  { pattern = "gallery.yourdomain.com/*", custom_domain = true }
]
```

### ç¼“å­˜ç­–ç•¥

Workers ç‰ˆæœ¬ä½¿ç”¨å¤šå±‚ç¼“å­˜ï¼š

1. **è¾¹ç¼˜ç¼“å­˜**: Cloudflare CDN è‡ªåŠ¨ç¼“å­˜é™æ€èµ„æº
2. **R2 ç¼“å­˜**: ç¼©ç•¥å›¾å’Œå¤„ç†åçš„å›¾ç‰‡ç¼“å­˜
3. **KV ç¼“å­˜**: å…ƒæ•°æ®å’Œæ¸…å•æ–‡ä»¶ç¼“å­˜

### æ€§èƒ½ä¼˜åŒ–

- **å›¾ç‰‡ä¼˜åŒ–**: è‡ªåŠ¨ WebP è½¬æ¢å’Œå‹ç¼©
- **ç¼©ç•¥å›¾ç”Ÿæˆ**: å¤šå°ºå¯¸ç¼©ç•¥å›¾æŒ‰éœ€ç”Ÿæˆ
- **CDN åŠ é€Ÿ**: å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹åˆ†å‘
- **æ™ºèƒ½ç¼“å­˜**: åŸºäºæ–‡ä»¶ä¿®æ”¹æ—¶é—´çš„å¢é‡æ›´æ–°

## ğŸ“Š ç›‘æ§å’Œåˆ†æ

### Cloudflare Analytics

åœ¨ Cloudflare Dashboard ä¸­æŸ¥çœ‹ï¼š
- è¯·æ±‚é‡å’Œå“åº”æ—¶é—´
- é”™è¯¯ç‡å’ŒçŠ¶æ€ç åˆ†å¸ƒ
- åœ°ç†åˆ†å¸ƒå’Œæµé‡æ¥æº
- Workers æ‰§è¡Œæ—¶é—´å’Œå†…å­˜ä½¿ç”¨

### è‡ªå®šä¹‰ç›‘æ§

```bash
# æŸ¥çœ‹ Worker æ—¥å¿—
wrangler tail

# æŸ¥çœ‹ R2 ä½¿ç”¨æƒ…å†µ
wrangler r2 bucket list

# æŸ¥çœ‹ KV ä½¿ç”¨æƒ…å†µ
wrangler kv:namespace list
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

- **è®¿é—®æ§åˆ¶**: é€šè¿‡ Cloudflare Access æ§åˆ¶ç®¡ç†æ¥å£
- **API é™æµ**: å†…ç½®è¯·æ±‚é¢‘ç‡é™åˆ¶
- **CORS é…ç½®**: å®‰å…¨çš„è·¨åŸŸèµ„æºå…±äº«è®¾ç½®
- **å†…å®¹å®‰å…¨**: è‡ªåŠ¨å›¾ç‰‡æ ¼å¼éªŒè¯å’Œå®‰å…¨æ£€æŸ¥

## ğŸ’° æˆæœ¬ä¼˜åŒ–

### Cloudflare Workers å…è´¹é¢åº¦
- **è¯·æ±‚**: 100,000 æ¬¡/å¤©
- **CPU æ—¶é—´**: 10ms/è¯·æ±‚
- **å†…å­˜**: 128MB

### R2 å­˜å‚¨å®šä»·
- **å­˜å‚¨**: $0.015/GB/æœˆ
- **Class A æ“ä½œ**: $4.50/ç™¾ä¸‡æ¬¡
- **Class B æ“ä½œ**: $0.36/ç™¾ä¸‡æ¬¡
- **å‡ºç«™æµé‡**: å…è´¹ (é€šè¿‡ Cloudflare CDN)

### ä¼˜åŒ–å»ºè®®
- ä½¿ç”¨ç¼©ç•¥å›¾å‡å°‘å¸¦å®½æ¶ˆè€—
- å¯ç”¨å›¾ç‰‡å‹ç¼©å’Œ WebP è½¬æ¢
- åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥
- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„èµ„æº

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **éƒ¨ç½²å¤±è´¥**
   ```bash
   # æ£€æŸ¥ wrangler.toml é…ç½®
   wrangler whoami
   wrangler r2 bucket list
   ```

2. **å›¾ç‰‡æ— æ³•æ˜¾ç¤º**
   ```bash
   # æ£€æŸ¥ R2 å­˜å‚¨æ¡¶æƒé™
   wrangler r2 object list afilmory-photos
   ```

3. **åŒæ­¥å¤±è´¥**
   ```bash
   # æŸ¥çœ‹ Worker æ—¥å¿—
   wrangler tail
   ```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
wrangler dev --local --debug

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
wrangler tail --format=pretty
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License Â© 2025

---

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ª â­ï¸ Starï¼